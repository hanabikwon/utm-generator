<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>UTM 생성기</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #FAF8F3;
            min-height: 100vh;
            padding: 20px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .logo-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .logo-circle {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            overflow: hidden;
            margin: 0 auto 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            background: #FAF8F3;
        }

        .logo-circle img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .container {
            background: #FFFEFB;
            border-radius: 16px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 40px;
            max-width: 700px;
            width: 100%;
        }
        
        h1 {
            color: #2E3D1F;
            margin-bottom: 10px;
            font-size: 28px;
            text-align: center;
        }

        .subtitle {
            color: #5A6B49;
            margin-bottom: 40px;
            font-size: 14px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 32px;
        }
        
        label {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
            font-size: 14px;
        }

        .required {
            color: #e74c3c;
            margin-left: 4px;
        }

        .optional {
            color: #95a5a6;
            font-weight: normal;
            font-size: 12px;
            margin-left: 4px;
        }
        
        input, select {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.5;
            transition: border-color 0.3s;
            background-color: #fff;
        }
        
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            padding-right: 48px;
            background-image: linear-gradient(45deg, transparent 50%, #8B9A6B 50%),
                              linear-gradient(135deg, #8B9A6B 50%, transparent 50%),
                              linear-gradient(to right, #e0e0e0, #e0e0e0);
            background-position: calc(100% - 22px) calc(50% - 5px),
                               calc(100% - 14px) calc(50% - 5px),
                               calc(100% - 36px) 50%;
            background-size: 8px 8px, 8px 8px, 2px 60%;
            background-repeat: no-repeat;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #8B9A6B;
        }
        
        .hint {
            font-size: 12px;
            color: #8B9A6B;
            margin-left: 8px;
            font-weight: normal;
        }

        .custom-input {
            display: none;
            margin-top: 10px;
            font-size: 14px;
        }
        
        .result-section {
            margin-top: 48px;
            padding: 24px;
            background: #f8f9fa;
            border-radius: 8px;
            display: none;
        }
        
        .result-section.show {
            display: block;
        }
        
        .result-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .result-url {
            background: white;
            padding: 15px;
            border-radius: 8px;
            word-break: break-all;
            font-family: monospace;
            font-size: 13px;
            color: #8B9A6B;
            border: 2px solid #E8E3D8;
            margin-bottom: 15px;
        }

        .short-url-container {
            display: none;
        }

        #copyShortBtn {
            display: none;
        }
        
        .copy-short-btn {
            background: #b68c5a;
            color: white;
        }

        .copy-short-btn:hover {
            background: #a57f50;
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        button {
            flex: 1;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .generate-btn {
            background: #8B9A6B;
            color: white;
            margin-top: 10px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .generate-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(139, 154, 107, 0.4);
        }
        
        .copy-btn {
            background: #D4A574;
            color: white;
        }

        .copy-btn:hover {
            background: #C4956A;
        }
        
        .clear-btn {
            background: #F5F5DC;
            color: #333;
            border: 2px solid #E8E3D8;
        }

        .clear-btn:hover {
            background: #EEECD8;
        }
        
        .success-message {
            background: #7A9B5C;
            color: white;
            padding: 10px;
            border-radius: 8px;
            text-align: center;
            margin-top: 10px;
            display: none;
            font-size: 14px;
        }
        
        .success-message.show {
            display: block;
        }

        .save-status {
            margin-top: 12px;
            font-size: 13px;
            color: #5A6B49;
        }

        .save-status.success {
            color: #2E3D1F;
        }

        .save-status.error {
            color: #c0392b;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo-container">
            <div class="logo-circle">
                <img src="./images/logo.png" alt="Recipesoup Logo">
            </div>
        </div>

        <h1>UTM 파라미터 생성기</h1>
        <p class="subtitle">마케팅 캠페인 추적을 위한 UTM 링크를 쉽게 만들어보세요</p>
        
        <form id="utmForm">
            <div class="form-group">
                <label>웹사이트 URL <span class="required">*</span> <span class="hint">추적하려는 페이지의 전체 URL</span></label>
                <input type="url" id="url" placeholder="https://example.com" required>
            </div>
            
            <div class="form-group">
                <label>캠페인 소스 (Source) <span class="required">*</span> <span class="hint">트래픽 출처</span></label>
                <select id="source" required>
                    <option value="" selected>선택하지 않음</option>
                    <option value="linkedin">Linkedin (링크드인)</option>
                    <option value="youtube">Youtube (유튜브)</option>
                    <option value="appstore">Appstore (앱스토어)</option>
                    <option value="instagram">Instagram (인스타그램)</option>
                    <option value="blog">Blog (블로그)</option>
                    <option value="newsletter">Newsletter (뉴스레터)</option>
                    <option value="custom">직접 입력</option>
                </select>
                <input type="text" id="sourceCustom" class="custom-input" placeholder="직접 입력 시 소스를 입력하세요" aria-label="캠페인 소스 직접 입력">
            </div>
            
            
            <div class="form-group">
                <label>캠페인 매체 (Medium) <span class="required">*</span> <span class="hint">마케팅 매체 유형</span></label>
                <select id="medium" required>
                    <option value="" selected>선택하지 않음</option>
                    <option value="social">Social (소셜 미디어)</option>
                    <option value="cpc">CPC (클릭당 과금 광고)</option>
                    <option value="email">Email (이메일)</option>
                    <option value="banner">Banner (배너 광고)</option>
                    <option value="affiliate">Affiliate (제휴)</option>
                    <option value="organic">Organic (자연 검색)</option>
                    <option value="referral">Referral (추천)</option>
                    <option value="custom">직접 입력</option>
                </select>
                <input type="text" id="mediumCustom" class="custom-input" placeholder="직접 입력 시 매체를 입력하세요" aria-label="캠페인 매체 직접 입력">
            </div>
            
            <div class="form-group">
                <label>캠페인 이름 (Campaign) <span class="required">*</span> <span class="hint">캠페인 그룹 (A/B 테스트, 시즈널 프로모션, 시리즈 등)</span></label>
                <select id="campaign" required>
                    <option value="" selected>선택하지 않음</option>
                    <option value="recipesoup_series">recipesoup_series</option>
                    <option value="custom">직접 입력</option>
                </select>
                <input type="text" id="campaignCustom" class="custom-input" placeholder="직접 입력 시 캠페인 이름을 입력하세요" aria-label="캠페인 이름 직접 입력">
            </div>
            
            <div class="form-group">
                <label>캠페인 콘텐츠 (Content) <span class="optional">선택사항</span> <span class="hint">같은 캠페인 내 콘텐츠 구분 </span></label>
                <select id="content">
                    <option value="" selected>선택하지 않음</option>
                    <option value="prolog">prolog</option>
                    <option value="episode1">episode1</option>
                    <option value="episode2">episode2</option>
                    <option value="episode3">episode3</option>
                    <option value="episode5">episode5</option>
                    <option value="episode6">episode6</option>
                    <option value="episode7">episode7</option>
                    <option value="episode8">episode8</option>
                    <option value="episode9">episode9</option>
                    <option value="episode10">episode10</option>
                    <option value="custom">직접 입력</option>
                </select>
                <input type="text" id="contentCustom" class="custom-input" placeholder="직접 입력 시 콘텐츠를 입력하세요" aria-label="캠페인 콘텐츠 직접 입력">
            </div>
            
            <div class="form-group">
                <label>캠페인 키워드 (Term) <span class="optional">선택사항</span> <span class="hint">(검색 키워드 (주로 paid 검색 광고)</span></label>
                <input type="text" id="term" placeholder="예: ai_recipe_app">
            </div>
            
            <button type="submit" class="generate-btn">UTM 링크 생성하기</button>
        </form>
        
        <div class="result-section" id="resultSection">
            <div class="result-label">생성된 UTM 링크</div>
            <div class="result-url" id="resultUrl"></div>

            <div class="short-url-container" id="shortUrlContainer">
                <div class="result-label">단축 링크</div>
                <div class="result-url" id="resultShortUrl"></div>
            </div>

            <div class="button-group">
                <button class="clear-btn" type="button" onclick="clearForm()">초기화</button>
                <button class="copy-btn" type="button" onclick="copyUrl()">링크 복사</button>
                <button class="copy-btn copy-short-btn" id="copyShortBtn" type="button" onclick="copyShortUrl()">단축 링크 복사</button>
            </div>

            <div class="save-status" id="saveStatus"></div>
            <div class="success-message" id="successMessage">✓ 클립보드에 복사되었습니다!</div>
        </div>
    </div>

    <footer style="text-align: center; margin-top: 40px; color: #5A6B49; font-size: 12px;">
        &copy; 2025 Recipesoup
    </footer>
    
    <script>
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbwiX53AWTSazM9ZzuRr3-A2S3YXejX_KCEYRZW08SremyfVo6oNB5riY6biVZhopTKg/exec';

        const customInputs = {};
        const customConfigs = [
            { selectId: 'source', inputId: 'sourceCustom', required: true },
            { selectId: 'medium', inputId: 'mediumCustom', required: true },
            { selectId: 'campaign', inputId: 'campaignCustom', required: true },
            { selectId: 'content', inputId: 'contentCustom', required: false }
        ];

        const resultSection = document.getElementById('resultSection');
        const resultUrlEl = document.getElementById('resultUrl');
        const shortUrlContainer = document.getElementById('shortUrlContainer');
        const shortUrlEl = document.getElementById('resultShortUrl');
        const copyShortBtn = document.getElementById('copyShortBtn');
        const saveStatusEl = document.getElementById('saveStatus');
        const successMessageEl = document.getElementById('successMessage');
        const successMessageDefault = successMessageEl.textContent;

        customConfigs.forEach(setupCustomInput);

        function setupCustomInput({ selectId, inputId, required }) {
            const selectEl = document.getElementById(selectId);
            const inputEl = document.getElementById(inputId);

            const toggleInput = () => {
                if (selectEl.value === 'custom') {
                    inputEl.style.display = 'block';
                    inputEl.required = required;
                } else {
                    inputEl.style.display = 'none';
                    inputEl.required = false;
                    inputEl.value = '';
                }
            };

            toggleInput();
            selectEl.addEventListener('change', toggleInput);

            customInputs[selectId] = { selectEl, inputEl, toggleInput };
        }

        function getCustomValue(selectId) {
            const { selectEl, inputEl } = customInputs[selectId];
            const value = selectEl.value;
            if (value === 'custom') {
                return inputEl.value.trim();
            }
            return value.trim();
        }

        document.getElementById('utmForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            let baseUrl = document.getElementById('url').value.trim();
            const source = getCustomValue('source');
            const medium = getCustomValue('medium');
            const campaign = getCustomValue('campaign');
            const content = getCustomValue('content');
            const term = document.getElementById('term').value.trim();

            if (!baseUrl.startsWith('http://') && !baseUrl.startsWith('https://')) {
                baseUrl = 'https://' + baseUrl;
            }

            const separator = baseUrl.includes('?') ? '&' : '?';

            let utmUrl = baseUrl + separator +
                         'utm_source=' + encodeURIComponent(source) +
                         '&utm_medium=' + encodeURIComponent(medium) +
                         '&utm_campaign=' + encodeURIComponent(campaign);

            if (content) {
                utmUrl += '&utm_content=' + encodeURIComponent(content);
            }

            if (term) {
                utmUrl += '&utm_term=' + encodeURIComponent(term);
            }

            resultUrlEl.textContent = utmUrl;
            resultSection.classList.add('show');
            successMessageEl.classList.remove('show');
            successMessageEl.textContent = successMessageDefault;

            shortUrlContainer.style.display = 'none';
            copyShortBtn.style.display = 'none';
            shortUrlEl.textContent = '';
            saveStatusEl.textContent = '';
            saveStatusEl.classList.remove('success', 'error');

            resultSection.scrollIntoView({ behavior: 'smooth' });

            await saveLinkToSheet({
                originalUrl: baseUrl,
                utmSource: source,
                utmMedium: medium,
                utmCampaign: campaign,
                utmContent: content,
                utmTerm: term,
                memo: '',
                utmUrl
            });
        });

        function copyUrl() {
            const urlText = resultUrlEl.textContent;
            if (!urlText) {
                return;
            }
            navigator.clipboard.writeText(urlText).then(function() {
                showCopyMessage('✓ UTM 링크가 복사되었습니다!');
            });
        }

        function clearForm() {
            document.getElementById('utmForm').reset();
            resultSection.classList.remove('show');
            successMessageEl.classList.remove('show');
            successMessageEl.textContent = successMessageDefault;
            resultUrlEl.textContent = '';
            shortUrlEl.textContent = '';
            shortUrlContainer.style.display = 'none';
            copyShortBtn.style.display = 'none';
            saveStatusEl.textContent = '';
            saveStatusEl.classList.remove('success', 'error');

            Object.values(customInputs).forEach(({ inputEl, toggleInput }) => {
                inputEl.value = '';
                toggleInput();
            });
        }

        function copyShortUrl() {
            const urlText = shortUrlEl.textContent;
            if (!urlText) {
                return;
            }
            navigator.clipboard.writeText(urlText).then(function() {
                showCopyMessage('✓ 단축 링크가 복사되었습니다!');
            });
        }

        function showCopyMessage(message) {
            successMessageEl.textContent = message;
            successMessageEl.classList.add('show');
            setTimeout(function() {
                successMessageEl.classList.remove('show');
                successMessageEl.textContent = successMessageDefault;
            }, 3000);
        }

        async function saveLinkToSheet(payload) {
            if (!WEB_APP_URL || WEB_APP_URL.includes('YOUR_WEB_APP_ID')) {
                saveStatusEl.textContent = 'Apps Script 웹앱 URL을 설정한 뒤 다시 시도하세요.';
                saveStatusEl.classList.add('error');
                return;
            }

            try {
                saveStatusEl.textContent = 'Google Sheets에 저장 중입니다...';
                saveStatusEl.classList.remove('error', 'success');

                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    throw new Error('Failed with status ' + response.status);
                }

                const data = await response.json();

                if (data && data.shortUrl) {
                    shortUrlEl.textContent = data.shortUrl;
                    shortUrlContainer.style.display = 'block';
                    copyShortBtn.style.display = 'block';
                } else {
                    shortUrlEl.textContent = '단축 URL 응답을 받지 못했습니다.';
                    shortUrlContainer.style.display = 'block';
                    copyShortBtn.style.display = 'none';
                }

                saveStatusEl.textContent = '시트에 저장되었습니다.';
                saveStatusEl.classList.add('success');
            } catch (error) {
                console.error('Failed to save link to sheet', error);
                saveStatusEl.textContent = '시트 저장에 실패했습니다. 잠시 후 다시 시도하세요.';
                saveStatusEl.classList.remove('success');
                saveStatusEl.classList.add('error');
                shortUrlContainer.style.display = 'none';
                copyShortBtn.style.display = 'none';
                shortUrlEl.textContent = '';
            }
        }
    </script>
</body>
</html>
